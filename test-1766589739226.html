
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bài Tập Tiếng Trung - HSK 1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        const TEST_DATA = {"listening_tf":{"title":"Nghe: Phán đoán đúng sai (3 điểm)","questions":[{"id":1,"audio_script":"她是我的老师。","statement":"她不是学生。","answer":"T"},{"id":2,"audio_script":"你家有五个人：爸爸、妈妈、哥哥、姐姐和我。","statement":"他家有三个人。","answer":"F"},{"id":3,"audio_script":"王：再见！李：再见！","statement":"他们说你好。","answer":"F"}]},"listening_mc":{"title":"Nghe: Chọn đáp án đúng (3 điểm)","questions":[{"id":1,"audio_script":"这是我的学校。","question_text":"说话人指着什么？","options":[{"id":"A","text":"老师"},{"id":"B","text":"学生"},{"id":"C","text":"学校"},{"id":"D","text":"家"}],"answer":"C"},{"id":2,"audio_script":"你叫什么名字？","question_text":"说话人想知道什么？","options":[{"id":"A","text":"名字"},{"id":"B","text":"职业"},{"id":"C","text":"爱好"},{"id":"D","text":"年龄"}],"answer":"A"},{"id":3,"audio_script":"谢谢你，李老师。","question_text":"谁在说谢谢？","options":[{"id":"A","text":"爸爸"},{"id":"B","text":"老师"},{"id":"C","text":"妈妈"},{"id":"D","text":"学生"}],"answer":"D"}]},"reading_vocab":{"title":"Đọc: Chọn từ điền trống (4 điểm)","options":[{"id":"A","text":"老师 (lǎoshī)"},{"id":"B","text":"家 (jiā)"},{"id":"C","text":"叫 (jiào)"},{"id":"D","text":"学校 (xuéxiào)"},{"id":"E","text":"谢谢 (xièxie)"}],"questions":[{"id":1,"text":"我爱我的____。 (Wǒ ài wǒ de ____.)","answer":"B"},{"id":2,"text":"请问，你____什么？ (Qǐng wèn, nǐ ____ shénme?)","answer":"C"},{"id":3,"text":"李____，你好！ (Lǐ ____, nǐ hǎo!)","answer":"A"},{"id":4,"text":"我在____学习汉语。 (Wǒ zài ____ xuéxí Hànyǔ.)","answer":"D"}]},"reading_comp":{"title":"Đọc: Đọc hiểu đoạn văn (2 điểm)","passage":"我叫小明，我是学生。我的爸爸是老师。我的妈妈不是老师，她在家。我们都很好。我在学校学习。","questions":[{"id":1,"text":"谁是老师？","options":[{"id":"A","text":"小明"},{"id":"B","text":"小明的爸爸"},{"id":"C","text":"小明的妈妈"},{"id":"D","text":"他们都不是"}],"answer":"B"},{"id":2,"text":"小明的妈妈在哪里？","options":[{"id":"A","text":"在学校"},{"id":"B","text":"在医院"},{"id":"C","text":"在家"},{"id":"D","text":"在饭店"}],"answer":"C"}]},"writing_order":{"title":"Viết: Sắp xếp câu (3 điểm)","questions":[{"id":1,"segments":["A. 老师","B. 他","C. 是","D. 我的"],"answer":"B C D A"},{"id":2,"segments":["A. 是","B. 吗","C. 你","D. 学生"],"answer":"C A D B"},{"id":3,"segments":["A. 再见","B. 爸爸","C. 妈妈","D. 和"],"answer":"B D C A"}]}};
        const CONFIG = {"levelGroup":"Sơ cấp","hskLevel":"HSK 1","topic":"Gia đình & Trường học","teacherName":"DSS","googleSheetUrl":"https://script.google.com/macros/s/AKfycbxV_S0rNHbOQx-hnjjlQGqdvLBN5GlTog0q8erd1XMpPX7XkuGjIxJnDEPPDJQnpGnf9g/exec","types":{"listening_tf":{"id":"listening_tf","label":"Nghe: Đúng/Sai","group":"listening","enabled":true,"count":3,"points":1},"listening_mc":{"id":"listening_mc","label":"Nghe: Trắc nghiệm","group":"listening","enabled":true,"count":3,"points":1},"reading_vocab":{"id":"reading_vocab","label":"Đọc: Điền từ","group":"reading","enabled":true,"count":4,"points":0.5},"reading_comp":{"id":"reading_comp","label":"Đọc: Đọc hiểu","group":"reading","enabled":true,"count":1,"points":2},"writing_order":{"id":"writing_order","label":"Viết: Sắp xếp câu","group":"writing","enabled":true,"count":3,"points":1},"writing_trans":{"id":"writing_trans","label":"Viết: Dịch Việt-Trung","group":"writing","enabled":false,"count":2,"points":1.5}}};
    </script>
    <style>
        .warning-toast {
            animation: slideIn 0.5s ease-out forwards;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen pb-20 select-none">
    <div id="app-root"></div>
    
    <!-- Monitoring Toasts Container -->
    <div id="toast-container" class="fixed top-20 right-4 z-50 flex flex-col gap-2"></div>

    <script>
        let userAnswers = {};
        let showResults = false;
        let score = 0;
        let playingId = null;
        
        // --- MONITORING STATE ---
        let monitoringData = {
            thoatManHinh: 0,
            saoChep: 0,
            dan: 0
        };

        function showWarning(msg) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'warning-toast bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded shadow-lg flex items-center max-w-sm';
            toast.innerHTML = '<i class="fas fa-exclamation-triangle mr-3 text-xl"></i><div><p class="font-bold">Cảnh báo gian lận</p><p class="text-sm">'+msg+'</p></div>';
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // --- ANTI-CHEAT LISTENERS ---
        document.addEventListener('visibilitychange', () => {
            if (document.hidden && !showResults) {
                monitoringData.thoatManHinh++;
                showWarning('Bạn vừa thoát màn hình! Hệ thống đã ghi nhận.');
            }
        });

        document.addEventListener('copy', (e) => {
            if(!showResults) {
                monitoringData.saoChep++;
                showWarning('Hành động SAO CHÉP bị cấm!');
                e.preventDefault();
            }
        });

        document.addEventListener('paste', (e) => {
            if(!showResults) {
                monitoringData.dan++;
                showWarning('Hành động DÁN bị cấm!');
                e.preventDefault();
            }
        });
        
        document.addEventListener('contextmenu', event => event.preventDefault());


        function renderApp() {
            const root = document.getElementById('app-root');
            const teacherDisplay = CONFIG.teacherName ? 
                `<div class="text-blue-100 text-sm mt-1"><i class="fas fa-chalkboard-teacher mr-1"></i> Giáo viên: <b>${CONFIG.teacherName}</b></div>` : '';

            root.innerHTML = `
                <div class="bg-blue-800 text-white p-4 shadow-md sticky top-0 z-40">
                    <div class="max-w-4xl mx-auto flex justify-between items-center">
                        <div>
                            <h1 class="font-bold text-xl"><i class="fas fa-graduation-cap mr-2"></i>Bài Làm Học Sinh</h1>
                            ${teacherDisplay}
                        </div>
                        <div class="text-right text-sm">
                            <div class="opacity-80">Mã đề: ${Date.now().toString().slice(-6)}</div>
                            <div class="font-bold">${CONFIG.hskLevel}</div>
                        </div>
                    </div>
                </div>
                
                <div class="max-w-4xl mx-auto p-4 mt-6">
                    <div class="bg-white p-8 rounded-t-xl shadow border-b-2 border-dashed border-gray-300 text-center relative overflow-hidden">
                        <!-- Anti-cheat Badge -->
                        <div class="absolute top-0 right-0 bg-red-100 text-red-600 px-3 py-1 rounded-bl-lg text-xs font-bold border-l border-b border-red-200">
                            <i class="fas fa-shield-alt mr-1"></i> Giám sát bật
                        </div>

                        <h2 class="text-3xl font-serif font-bold text-gray-900 mb-2 uppercase">${CONFIG.topic}</h2>
                         <p class="text-gray-500 mt-2 italic">Bài kiểm tra kỹ năng ${CONFIG.hskLevel} (Tổng điểm: 13)</p>
                        
                        <div class="mt-6 p-4 bg-yellow-50 text-yellow-800 rounded-lg inline-flex items-center text-sm border border-yellow-200 shadow-sm text-left">
                            <i class="fas fa-info-circle mr-3 text-lg text-yellow-600"></i> 
                            <div>
                                <b>Quy chế thi:</b><br/>
                                - Không thoát màn hình, không chuyển tab.<br/>
                                - Không sao chép/dán nội dung.<br/>
                                - Bật loa để làm phần nghe.
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-gray-600 px-4 md:px-8 border-t pt-6 mt-8">
                            <div class="text-left">
                                <label class="block text-xs font-bold uppercase text-gray-400 mb-1">Họ và tên học sinh (*)</label>
                                <input id="student-name" type="text" class="w-full text-lg font-medium border-b-2 border-gray-300 focus:border-blue-600 focus:outline-none py-1 transition-colors" placeholder="Nhập họ tên...">
                            </div>
                            <div class="text-left">
                                <label class="block text-xs font-bold uppercase text-gray-400 mb-1">Lớp (*)</label>
                                <input id="student-class" type="text" class="w-full text-lg font-medium border-b-2 border-gray-300 focus:border-blue-600 focus:outline-none py-1 transition-colors" placeholder="Ví dụ: 12A1...">
                            </div>
                        </div>
                         <div class="text-center mt-6">
                                <label class="block text-xs font-bold uppercase text-gray-400 mb-1">Kết quả</label>
                                <span id="score-display" class="font-bold text-4xl text-gray-300">${showResults ? score : '--'}<span class="text-xl text-gray-400">/13</span></span>
                                <div id="submit-status" class="h-6 text-sm font-medium mt-2"></div>
                         </div>
                    </div>

                    <div class="bg-white p-8 rounded-b-xl shadow-lg space-y-8 min-h-[400px]">
                        ${Object.keys(TEST_DATA).map(key => renderSection(key, TEST_DATA[key])).join('')}
                    </div>
                </div>

                <div class="fixed bottom-0 w-full bg-white border-t p-4 flex justify-center shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] z-40">
                     ${!showResults ? 
                        `<button id="submit-btn" onclick="checkAnswers()" class="bg-gradient-to-r from-blue-600 to-indigo-700 hover:from-blue-700 hover:to-indigo-800 text-white px-10 py-3 rounded-full font-bold shadow-lg transform transition active:scale-95 flex items-center text-lg">
                            <i class="fas fa-check-circle mr-2"></i> Nộp Bài
                        </button>` : 
                        `<button onclick="location.reload()" class="bg-gray-800 hover:bg-gray-900 text-white px-8 py-3 rounded-full font-medium flex items-center shadow-lg">
                            <i class="fas fa-redo mr-2"></i> Làm Lại
                        </button>`
                    }
                </div>
            `;
        }

        function handlePlayAudio(btn) {
            const text = btn.getAttribute('data-text');
            if(!text) return;
            
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            btn.classList.add('bg-blue-200');
            window.speechSynthesis.cancel();
            
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'zh-CN';
            utterance.rate = 0.8;
            utterance.onend = () => { btn.innerHTML = originalHTML; btn.classList.remove('bg-blue-200'); };
            utterance.onerror = () => { btn.innerHTML = originalHTML; btn.classList.remove('bg-blue-200'); };
            window.speechSynthesis.speak(utterance);
        }

        function handleInput(key, value) {
            if(showResults) return;
            userAnswers[key] = value;
            const el = document.getElementById('input-'+key);
            if(el) el.value = value;
        }

        async function checkAnswers() {
            const name = document.getElementById('student-name').value.trim();
            const className = document.getElementById('student-class').value.trim();
            
            if(!name || !className) {
                alert('Vui lòng nhập đầy đủ Họ tên và Lớp trước khi nộp bài!');
                return;
            }

            if(!confirm('Bạn có chắc chắn muốn nộp bài?')) return;

            const btn = document.getElementById('submit-btn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Đang chấm...';

            let totalCorrectPoints = 0;
            let answerDetails = []; 

            Object.keys(TEST_DATA).forEach(sectionKey => {
                const section = TEST_DATA[sectionKey];
                const sectionConfig = Object.values(CONFIG.types).find(t => sectionKey.includes(t.id));
                const pointsPerQ = sectionConfig ? sectionConfig.points : 0;

                section.questions.forEach(q => {
                    const key = sectionKey + '-' + q.id;
                    const userAns = (userAnswers[key] || '').trim().toUpperCase();
                    const correctAns = (q.answer || q.chinese_answer || '').trim().toUpperCase();
                    
                    let isCorrect = userAns === correctAns;
                    if(isCorrect) totalCorrectPoints += pointsPerQ;
                    
                    answerDetails.push({
                        questionNumber: key,
                        isCorrect: isCorrect,
                        type: sectionKey.includes('writing') ? 'writing' : 'choice'
                    });

                    // UI Update Logic
                    const container = document.getElementById('container-'+key);
                    if(container) {
                        const oldMsg = container.querySelectorAll('.result-msg');
                        oldMsg.forEach(el => el.remove());
                        if(isCorrect) {
                            container.classList.add('bg-green-50', 'border-green-200');
                            container.insertAdjacentHTML('beforeend', '<div class="result-msg text-green-600 font-bold mt-2 text-sm flex items-center"><i class="fas fa-check-circle mr-1"></i> Chính xác</div>');
                        } else {
                            container.classList.add('bg-red-50', 'border-red-200');
                            container.insertAdjacentHTML('beforeend', '<div class="result-msg text-red-600 font-bold mt-2 text-sm flex items-center"><i class="fas fa-times-circle mr-1"></i> Đáp án đúng: ' + correctAns + '</div>');
                        }
                    }
                });
            });

            score = totalCorrectPoints.toFixed(1);
            showResults = true;
            
            // SEND TO GOOGLE SHEET
            if(CONFIG.googleSheetUrl) {
                const statusDiv = document.getElementById('submit-status');
                statusDiv.innerHTML = '<span class="text-blue-600"><i class="fas fa-sync fa-spin"></i> Đang gửi kết quả...</span>';
                
                try {
                    const formData = new URLSearchParams();
                    formData.append('timestamp', new Date().toLocaleString('vi-VN'));
                    formData.append('name', name);
                    formData.append('class', className);
                    formData.append('score', score + '/' + 13);
                    formData.append('assessment', 'Hoàn thành bài thi');
                    formData.append('examCode', CONFIG.topic);
                    formData.append('monitoringLog', JSON.stringify(monitoringData));
                    formData.append('answerDetails', JSON.stringify(answerDetails));

                    await fetch(CONFIG.googleSheetUrl, {
                        method: 'POST',
                        mode: 'no-cors', 
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: formData
                    });
                    
                    statusDiv.innerHTML = '<span class="text-green-600 font-bold"><i class="fas fa-check"></i> Đã lưu kết quả thành công!</span>';
                } catch (e) {
                    console.error(e);
                    statusDiv.innerHTML = '<span class="text-red-600 font-bold"><i class="fas fa-exclamation-triangle"></i> Lỗi gửi kết quả (mạng).</span>';
                }
            }

            renderApp();
            
            // Re-apply visuals
             setTimeout(() => {
                Object.keys(TEST_DATA).forEach(sectionKey => {
                    const section = TEST_DATA[sectionKey];
                    section.questions.forEach(q => {
                        const key = sectionKey + '-' + q.id;
                        const userAns = (userAnswers[key] || '').trim().toUpperCase();
                        const correctAns = (q.answer || q.chinese_answer || '').trim().toUpperCase();
                        const isCorrect = userAns === correctAns;
                        
                        const container = document.getElementById('container-'+key);
                        if(container) {
                             if(isCorrect) {
                                container.classList.add('bg-green-50', 'border-green-200');
                                container.insertAdjacentHTML('beforeend', '<div class="result-msg text-green-600 font-bold mt-2 text-sm flex items-center"><i class="fas fa-check-circle mr-1"></i> Chính xác</div>');
                            } else {
                                container.classList.add('bg-red-50', 'border-red-200');
                                container.insertAdjacentHTML('beforeend', '<div class="result-msg text-red-600 font-bold mt-2 text-sm flex items-center"><i class="fas fa-times-circle mr-1"></i> Đáp án đúng: ' + correctAns + '</div>');
                            }
                        }
                        
                        const textInput = document.getElementById('input-'+key);
                        if(textInput) textInput.value = userAnswers[key] || '';
                        
                        if(userAns) {
                             const selectedBtn = document.querySelector('button[data-key="'+key+'"][data-val="'+userAns+'"]');
                             if(selectedBtn) {
                                 selectedBtn.classList.add('ring-2', 'ring-offset-1', isCorrect ? 'ring-green-500' : 'ring-red-500', isCorrect ? 'bg-green-100' : 'bg-red-100');
                             }
                        }
                        
                         const inputs = document.querySelectorAll('[name="'+key+'"], button[data-key="'+key+'"], input[id="input-'+key+'"]');
                         inputs.forEach(i => i.disabled = true);
                    });
                });
                
                document.getElementById('student-name').value = name;
                document.getElementById('student-class').value = className;
                document.getElementById('student-name').disabled = true;
                document.getElementById('student-class').disabled = true;
            }, 50);
        }

        function renderSection(key, data) {
            let content = '';
            
            if (key.includes('listening') || key.includes('reading_comp')) {
                content = data.questions.map(q => {
                    const qKey = key + '-' + q.id;
                    let optionsHtml = '';
                    
                    const safeAudioText = q.audio_script ? q.audio_script.replace(/"/g, '&quot;') : '';
                    const audioBtn = q.audio_script ? 
                        `<button onclick="handlePlayAudio(this)" data-text="${safeAudioText}" class="w-10 h-10 rounded-full bg-blue-100 text-blue-600 flex-shrink-0 flex items-center justify-center hover:bg-blue-600 hover:text-white transition-all shadow-sm" title="Nghe"><i class="fas fa-volume-up"></i></button>` : '';

                    if(key.includes('_tf')) {
                         optionsHtml = `
                            <div class="flex gap-3 mt-3">
                                <button onclick="handleInput('${qKey}', 'T'); this.parentElement.querySelectorAll('button').forEach(b=>b.classList.remove('bg-blue-600','text-white')); this.classList.add('bg-blue-600','text-white')" data-key="${qKey}" data-val="T" class="flex-1 py-2 border border-blue-200 rounded-lg hover:bg-blue-50 font-medium transition-colors">Đúng (True)</button>
                                <button onclick="handleInput('${qKey}', 'F'); this.parentElement.querySelectorAll('button').forEach(b=>b.classList.remove('bg-blue-600','text-white')); this.classList.add('bg-blue-600','text-white')" data-key="${qKey}" data-val="F" class="flex-1 py-2 border border-blue-200 rounded-lg hover:bg-blue-50 font-medium transition-colors">Sai (False)</button>
                            </div>
                         `;
                    } else {
                         optionsHtml = `<div class="grid grid-cols-1 gap-2 mt-3">` + 
                            q.options.map(opt => `
                                <button onclick="handleInput('${qKey}', '${opt.id}'); this.parentElement.querySelectorAll('button').forEach(b=>b.classList.remove('bg-blue-100','border-blue-500')); this.classList.add('bg-blue-100','border-blue-500')" data-key="${qKey}" data-val="${opt.id}" class="text-left px-4 py-3 border border-gray-200 rounded-lg hover:bg-gray-50 flex transition-all group">
                                    <span class="font-bold mr-3 w-6 h-6 flex items-center justify-center bg-gray-100 rounded group-hover:bg-white">${opt.id}</span> 
                                    <span>${opt.text}</span>
                                </button>
                            `).join('') + 
                         `</div>`;
                    }

                    return `
                        <div id="container-${qKey}" class="mb-6 p-4 border border-gray-100 rounded-xl bg-gray-50/50 hover:bg-white hover:shadow-sm transition-all">
                            <div class="flex items-start gap-4 mb-2">
                                <span class="font-bold text-gray-400 mt-2">#${q.id}</span>
                                ${audioBtn}
                                <div class="flex-grow pt-1 text-lg text-gray-800 font-medium leading-relaxed">
                                    ${q.statement || q.question_text || q.text}
                                </div>
                            </div>
                            ${optionsHtml}
                        </div>
                    `;
                }).join('');
                
                if(data.passage) content = `<div class="bg-orange-50 p-5 rounded-lg mb-6 font-serif text-lg leading-loose border-l-4 border-orange-300 text-gray-800 shadow-sm">${data.passage}</div>` + content;
            } else {
                let pool = '';
                if(data.options) {
                    pool = `<div class="flex flex-wrap gap-3 mb-6 p-4 bg-blue-50/50 border border-blue-100 rounded-lg justify-center">` + 
                        data.options.map(o => `<span class="bg-white px-3 py-1.5 border border-blue-200 rounded-md shadow-sm text-blue-800"><b>${o.id}:</b> ${o.text}</span>`).join('') +
                    `</div>`;
                }
                
                content = pool + data.questions.map(q => {
                    const qKey = key + '-' + q.id;
                    return `
                        <div id="container-${qKey}" class="mb-4 p-4 border border-gray-100 rounded-xl hover:shadow-sm transition-all bg-white">
                             <div class="mb-3 text-lg flex gap-2">
                                <span class="font-bold text-gray-400">#${q.id}</span>
                                <span>${q.text || q.vietnamese || (q.segments ? q.segments.join(' / ') : '')}</span>
                             </div>
                             <input type="text" id="input-${qKey}" oninput="handleInput('${qKey}', this.value.toUpperCase())" placeholder="Nhập đáp án..." class="w-full border-2 border-gray-200 p-3 rounded-lg focus:border-blue-500 focus:outline-none uppercase font-bold text-gray-700 tracking-wider transition-colors">
                        </div>
                    `;
                }).join('');
            }

            return `
                <div class="mb-10">
                    <h3 class="text-xl font-bold text-blue-800 mb-6 border-b pb-2 uppercase flex items-center">
                        <i class="fas fa-bookmark mr-2 opacity-50"></i>
                        ${data.title}
                    </h3>
                    ${content}
                </div>
            `;
        }

        renderApp();
    </script>
</body>
</html>
    